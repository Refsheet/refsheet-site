container_commands:
  01_configure_asset_cors:
    command: "/tmp/configure_asset_cors.sh"

files:
  "/tmp/configure_asset_cors.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # remove old CORS file just in case
      rm -f /etc/nginx/conf.d/cors.conf

      pushd $(/opt/elasticbeanstalk/bin/get-config container -k config_staging_dir)
      echo "Adding CORS Config"
      NGINX_CONF="/opt/elasticbeanstalk/support/conf/webapp_healthd.conf"

      if [[ ! -f $NGINX_CONF ]]; then
        echo "Exit as CORS config not relevant."
        exit
      fi

      grep asset_cors.conf $NGINX_CONF || sed -i '/location \/assets {/a \ \ \ \ include /etc/nginx/asset_cors.conf;' $NGINX_CONF
      sed -i '/location \/ {/i \ \ root\ \/var\/app\/current\/public;' $NGINX_CONF
      sed -i '/location \/ {/i \ \ try_files\ $uri/index.html\ $uri\ @app;' $NGINX_CONF
      sed -i 's/location \/ {/location @app {/' $NGINX_CONF

      if ! grep -Fq "/cable" $NGINX_CONF; then
        echo "Adding Cable"
        sed -i '/location \/assets {/i \ \ location /cable {\n\ \ \ \ include /etc/nginx/cable.conf;\n\ \ }\n' $NGINX_CONF
      fi

      service nginx reload

  "/etc/nginx/asset_cors.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      add_header Access-Control-Allow-Origin *;
      add_header Access-Control-Allow-Credentials true;
      add_header Access-Control-Allow-Methods 'GET, OPTIONS, HEAD';
      add_header Access-Control-Max-Age 1728000;
      add_header X-Clacks-Overhead 'GNU Sir Terry Pratchett';

  "/etc/nginx/cable.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      proxy_pass http://my_app;
      proxy_http_version 1.1;
      proxy_set_header Upgrade "websocket";
      proxy_set_header Connection "Upgrade";
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
