steps:

  #== BUILD

  - name: 'gcr.io/kaniko-project/executor'
    args:
      - --destination=gcr.io/$PROJECT_ID/refsheet-site-ci:$REVISION_ID
      - --cache=true
      - --dockerfile=./Dockerfile.dev

  #== SETUP

  - name: 'gcr.io/cloud-builders/docker'
    args:
      - run
      - -d
      - --name=postgres
      - --network=cloudbuild
      - -e
      - POSTGRES_PASSWORD=fishsticks
      - postgres

  # Wait for Postgres to become available
  - name: 'jwilder/dockerize:0.6.1'
    args:
      - dockerize
      - -timeout=60s
      - -wait=tcp://postgres:5432

  # Setup Database
  - name: 'gcr.io/$PROJECT_ID/refsheet-site-ci:$REVISION_ID'
    args: ['bundle', 'exec', 'rake', 'db:migrate']

  #== TEST

  - name: 'gcr.io/$PROJECT_ID/refsheet-site-ci:$REVISION_ID'
    args: ['rspec', '--exclude-pattern', '**/features/**/*_spec.rb']
    secretEnv:
      - CODECOV_TOKEN

  - name: 'gcr.io/$PROJECT_ID/refsheet-site-ci:$REVISION_ID'
    args: ['rspec', '--pattern', '**/features/**/*_spec.rb']
    secretEnv:
      - CODECOV_TOKEN

  - name: 'gcr.io/$PROJECT_ID/refsheet-site-ci:$REVISION_ID'
    args: ['bin/entrypoint.dev.sh', 'yarn', 'run', 'test']

  - name: 'gcr.io/$PROJECT_ID/refsheet-site-ci:$REVISION_ID'
    args: ['bin/entrypoint.dev.sh', 'yarn', 'run', 'prettier-check']

  #== TEARDOWN

  - name: 'gcr.io/cloud-builders/docker'
    args: ['rm', '--force', 'postgres']

options:
  env:
    - RAILS_ENV=test
    - RACK_ENV=test
    - NODE_ENV=test
    - DB_HOST=postgres
    - DB_USERNAME=postgres
    - DB_PASSWORD=fishsticks
    - DB_DATABASE=postgres
    - CI=true

# Create Secrets with:
# echo "value" | gcloud kms encrypt --plaintext-file=- --ciphertext-file=- --location=global --keyring=refsheet-ci \
#   --key=refsheet-ci | base64 -w0

secrets:
  - kmsKeyName: projects/refsheet-239409/locations/global/keyRings/refsheet-ci/cryptoKeys/refsheet-ci
    secretEnv:
      CODECOV_TOKEN: CiQA5Rk5Qwx3O8FuITO2nXfDU9FAncqLzTA4dHyOC0z878Dgw5cSTgBhT4yKc9ln5ag02Syi3Joom8YkQf1LOmS3CHB0LSIP4KY7LPYp3QfIsWGYbBv5DjZUY+TVRz2wR9CMnI8YzKm+e0oT3cIqnGz7UAMPlg==

timeout: 3600s